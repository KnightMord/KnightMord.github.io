---
title: '2D Platformer Demo "骑士游戏"'
date: 2025-03-04
permalink: /posts/2025/03/knight/
---

本Demo素材大部分由itch.io上下载，小部分为我个人使用asp绘制。
作为一个主要作为自己练手的项目，编写时大量运用各种设计模式解耦，如策略模式，事件总线（观察者模式）等，模块之间松耦合。项目虽然内容填充的不多，但是已有一个健壮的框架，可以很方便地扩展与复用已有内容。
游戏使用InputSystem，可支持键鼠/手柄/触屏多端操作模式；采用自己编写的一套存档逻辑，可进行持久化存档；采用自己编写的音频播放系统，可提供细粒度的音频播放控制。
以下将对部分系统进行简要说明。

![菜单页](/images/knight/菜单页.png "菜单页")

角色操作
======
主角可以进行多种行为，如下图所展示：

![基本行动](/images/knight/基本行动.gif "基本行动")

动画状态机分为三层，额外的两层控制的是受伤闪烁/变红的表现，以及攻击/施法的状态。由于是2D帧动画，没法设置动画混合，否则按照这样分层后可以实现攻击时移动，腿也不会停下来的效果。

![主角动画状态机](/images/knight/主角动画状态机.png "主角动画状态机")

游戏中每种行为封装为一个类，部分行为怪物与玩家可复用，如攻击等；扩展时也可以设计为类银河城游戏中能力逐步解锁的系统，只需要添加/移除相应的组件就可以。

![主角Inspector](/images/knight/主角Inspector.png "主角Inspector")

跳跃
======
作为平台游戏的核心，跳跃手感是非常重要也很难做好的一环，很多市面上的独立游戏跳跃手感实际上都较为糟糕。这个demo中的跳跃部分是我对各种平台跳跃佳作（对象有空洞骑士、蔚蓝、奥日）的跳跃进行深入研究后设计的结果。除了延迟输入、土狼时间等较为常见的手感优化机制以外，我加入了主角跳跃过程的一个状态机，通过y轴速度的不同状态设置主角重力，达到一个较为不错的操作手感，解析图如下：

![跳跃解析](/images/knight/跳跃解析.png "跳跃解析")


敌人设计
======
敌人采用了更为复杂的状态机控制，每个敌人的每个状态都是一个类（但也有所有怪物共用的状态类，或从其他状态类继承），可实现很复杂的敌人行为逻辑，也方便进行敌人AI的设计。下图展示的兽人常态下会在指定路线巡逻（也可设置为idle），若在视线距离（可自定义）内发现主角则会立刻进入闭眼冲撞模式，往发现主角的方向冲撞，若冲到平台边缘会返回；若在若干秒内没有发现主角，就会进入搜索模式，左右环视几秒，如果依然没有发现主角，就会恢复到巡逻模式。

![敌人行为](/images/knight/敌人行为.gif "敌人行为")

![敌人动画状态机](/images/knight/敌人动画状态机.png "敌人动画状态机")
